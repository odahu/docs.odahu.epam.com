

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Local run (local model execution) &mdash; legion 1.2 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> legion
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="about.html">About Legion</a></li>
<li class="toctree-l1"><a class="reference internal" href="concepts.html">Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="gen_distros.html">Distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="gen_security.html">Security</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tutorials_wine.html">MLFlow</a></li>
</ul>
<p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="inst_cluster_installation.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="inst_cluster_installation.html#legion">Legion</a></li>
<li class="toctree-l1"><a class="reference internal" href="inst_cluster_installation.html#legion-cli">Legion CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="inst_cluster_installation.html#jupyter-plugin">Jupyter Plugin</a></li>
</ul>
<p class="caption"><span class="caption-text">Components</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="comp_edi.html">EDI</a></li>
<li class="toctree-l1"><a class="reference internal" href="comp_operator.html">Operator</a></li>
<li class="toctree-l1"><a class="reference internal" href="comp_mlflow_trainer.html">MLFlow Trainer</a></li>
<li class="toctree-l1"><a class="reference internal" href="comp_model_feedback.html">Model Feedback</a></li>
</ul>
<p class="caption"><span class="caption-text">Integrations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="int_metrics.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="int_airflow.html">Airflow</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="ref_configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="ref_kubernetes.html">Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="ref_model_api.html">Model API</a></li>
<li class="toctree-l1"><a class="reference internal" href="ref_model_format.html">Model Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="ref_networking.html">Networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="gen_glossary.html">Glossary</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="dev_general.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev_project_structure.html">Project structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev_project_structure.html#repositories-structure">Repositories structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev_hints.html">Development hints</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev_building.html">How to build docker images</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev_testing.html">Integration Testing</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">legion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Local run (local model execution)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/gs_local_run.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="local-run-local-model-execution">
<h1>Local run (local model execution)<a class="headerlink" href="#local-run-local-model-execution" title="Permalink to this headline">¶</a></h1>
<p>In order to run model in environment that is similar to train and execution environments Legion Platform provides you <code class="docutils literal notranslate"><span class="pre">legionctl</span> <span class="pre">create-sandbox</span></code> command that can create docker container with preinstalled requirements.</p>
<div class="section" id="prerequirements">
<h2>Prerequirements<a class="headerlink" href="#prerequirements" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Linux based system with bash (at least version 4)</li>
<li>Docker engine (at least version 17.0) with access from current user (<code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">ps</span></code> should executes without errors)</li>
<li>Python 3.6</li>
</ul>
</div>
<div class="section" id="how-to-run">
<h2>How to run?<a class="headerlink" href="#how-to-run" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li>Firstly, you have to install <code class="docutils literal notranslate"><span class="pre">legion</span></code> package from PyPi (you may do this in the dedicated environment, created by pipenv, for example).</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip install --user legion
</pre></div>
</div>
<ol class="simple">
<li>Then, you have to run <code class="docutils literal notranslate"><span class="pre">legionctl</span> <span class="pre">create-sandbox</span></code> command that will create <code class="docutils literal notranslate"><span class="pre">legion-activate.sh</span></code> script <strong>in the your current directory</strong>.</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>legionctl create-sandbox
</pre></div>
</div>
<p>You may override default parameters using CLI arguments or Legion application configuration (see <strong>configuration</strong> section).</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">--image</span></code> - docker image (named Legion Toolchain) from which container will be started. Default value comes from <code class="docutils literal notranslate"><span class="pre">legion.config.SANDBOX_PYTHON_TOOLCHAIN_IMAGE</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">--force-recreate</span></code> - recreate <code class="docutils literal notranslate"><span class="pre">legion-activate.sh</span></code> if it exists.</li>
</ul>
<p>Image should be compatible with Legion Platform. By default Legion Platform provides <strong>legion/python-toolchain</strong> public image.</p>
<p>Example of value: <code class="docutils literal notranslate"><span class="pre">docker-registry-host:900/legion/python-toolchain:1.0.0</span></code></p>
<ol class="simple">
<li>Activate Legion environment (go inside docker container)</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./legion-activate.sh
</pre></div>
</div>
<p>Execution of this command starts temporarly docker container (will be removed on exit) with mounting actual working directory to <code class="docutils literal notranslate"><span class="pre">/work-directory</span></code> path inside container.</p>
<p>At bootup occupied ports (that will route traffic from host to container) information will be printed to console.</p>
<p>Example of ports information:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Bootup</span> <span class="n">configuration</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Jupyter</span> <span class="n">server</span><span class="p">:</span> <span class="mi">56388</span>
<span class="o">*</span> <span class="n">PYDEVD</span> <span class="n">debugger</span> <span class="p">(</span><span class="n">reverse</span> <span class="n">connection</span> <span class="n">to</span> <span class="n">host</span><span class="p">):</span> <span class="n">disabled</span> <span class="p">(</span><span class="n">you</span> <span class="n">have</span> <span class="n">to</span> <span class="n">define</span> <span class="n">PYDEVD_HOST</span> <span class="ow">and</span> <span class="n">PYDEVD_PORT</span><span class="p">)</span>
<span class="o">*</span> <span class="n">PTVSD</span> <span class="n">debugger</span><span class="p">:</span> <span class="mi">56387</span>
<span class="o">*</span> <span class="n">PTVSD</span> <span class="n">wait</span><span class="o">-</span><span class="k">for</span><span class="o">-</span><span class="n">attach</span><span class="p">:</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">configured</span> <span class="p">(</span><span class="n">you</span> <span class="n">may</span> <span class="n">configure</span> <span class="n">it</span> <span class="n">using</span> <span class="n">PTVSD_WAIT_ATTACH</span><span class="p">)</span>
</pre></div>
</div>
<p>Block above says that ports 56388, 56387 have been mapped from your host to container, that means that traffic from <code class="docutils literal notranslate"><span class="pre">localhost:56388</span></code> will be routed to container’s <code class="docutils literal notranslate"><span class="pre">56388</span></code> port. This ports choose at each <code class="docutils literal notranslate"><span class="pre">legion-activate.sh</span></code> execution.</p>
<ol class="simple">
<li>Run your training scripts</li>
</ol>
<p>Inside container’s shell (bash) you may run your python code (using <code class="docutils literal notranslate"><span class="pre">python3</span></code> command), run your notebooks (using <code class="docutils literal notranslate"><span class="pre">jupyter</span> <span class="pre">nbconver</span> <span class="pre">--execute</span></code> command), run Jupyter notebook server (that will be accessible from your machine) or run other commands.</p>
<p>Your code may use <code class="docutils literal notranslate"><span class="pre">legion</span></code> python package to generate Legion Platform model binaries using <code class="docutils literal notranslate"><span class="pre">legion.model</span></code> API.</p>
<p>At the end of your pipeline you have to export and save your models (using <code class="docutils literal notranslate"><span class="pre">legion.model.export(....)</span></code> and <code class="docutils literal notranslate"><span class="pre">legion.model.save()</span></code> commands)</p>
<ol class="simple">
<li>Build model images</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>legionctl build
</pre></div>
</div>
<p>To build model images you have to run command above. It will self-capture current container with all installed dependecies, add additional packages (as a nginx webserver) and persist it on your machine’s docker engine as a new image.</p>
<p>Name of image will be printed in the console.</p>
</div>
<div class="section" id="how-to-use-with-jupyter-notebook">
<h2>How to use with Jupyter Notebook?<a class="headerlink" href="#how-to-use-with-jupyter-notebook" title="Permalink to this headline">¶</a></h2>
<p>You are free to run jupyter notebook (that is installed by default) inside development container.</p>
<p>Here is an example of command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>jupyter notebook
</pre></div>
</div>
<p>Jupyter notebook access URL will be printed to console.</p>
</div>
<div class="section" id="debugging">
<h2>Debugging<a class="headerlink" href="#debugging" title="Permalink to this headline">¶</a></h2>
<p>To debug your applications you may use next debugging protocols:</p>
<ul class="simple">
<li><a class="reference external" href="https://pypi.org/project/pydevd/">PyDevd</a> that is supported in PyCharm Professional, PyDev, VSCode Python</li>
<li><a class="reference external" href="https://pypi.org/project/ptvsd/">ptvsd</a> that is supported in VSCode</li>
</ul>
<div class="section" id="pydevd">
<h3>PyDevd<a class="headerlink" href="#pydevd" title="Permalink to this headline">¶</a></h3>
<p>PyDevd debugging works in a <strong>client (in your code) - server (in IDE)</strong> way through network connection.</p>
<p>To start debugging you have to:</p>
<ol class="simple">
<li>Start debugging server in your IDE.</li>
<li>Run <code class="docutils literal notranslate"><span class="pre">legion-activate.sh</span></code> with environment variables <code class="docutils literal notranslate"><span class="pre">PYDEVD_HOST</span></code> and <code class="docutils literal notranslate"><span class="pre">PYDEVD_PORT</span></code>.</li>
</ol>
<p>Example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PYDEVD_HOST</span><span class="o">=</span><span class="m">127</span>.0.0.1 <span class="nv">PYDEVD_PORT</span><span class="o">=</span><span class="m">8090</span> ./legion-activate.sh
</pre></div>
</div>
</div>
<div class="section" id="how-to-configure-debugging-using-pydevd-in-pycharm">
<h3>How to configure debugging using PyDevd in PyCharm<a class="headerlink" href="#how-to-configure-debugging-using-pydevd-in-pycharm" title="Permalink to this headline">¶</a></h3>
<p>You may use instructions from this link <a class="reference external" href="https://www.jetbrains.com/help/pycharm/remote-debugging-with-product.html">https://www.jetbrains.com/help/pycharm/remote-debugging-with-product.html</a>.</p>
</div>
</div>
<div class="section" id="ptvsd">
<h2>ptvsd<a class="headerlink" href="#ptvsd" title="Permalink to this headline">¶</a></h2>
<p><strong>ptvsd</strong> is a editor that has been developed dedicated for VSCode IDE. It works in a <strong>server (in your code) - client (in IDE) way</strong> through network connection. Your python application starts dedicated thread in which it server attach requests of debugger.</p>
<p>To start debugging you have to:</p>
<ol class="simple">
<li>Configure attaching in your IDE, choose port (for example 8000)</li>
<li>Run <code class="docutils literal notranslate"><span class="pre">legion-activate.sh</span></code> (<code class="docutils literal notranslate"><span class="pre">PTVSD_PORT</span></code> and <code class="docutils literal notranslate"><span class="pre">PTVSD_WAIT_ATTACH</span></code> are optional, default <code class="docutils literal notranslate"><span class="pre">PTVSD_WAIT_ATTACH=0</span></code>).</li>
</ol>
<p>Example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PTVSD_WAIT_ATTACH</span><span class="o">=</span><span class="m">1</span> ./legion-activate.sh
</pre></div>
</div>
<div class="section" id="how-to-configure-debugging-using-ptvsd-in-vscode">
<h3>How to configure debugging using ptvsd in VsCode<a class="headerlink" href="#how-to-configure-debugging-using-ptvsd-in-vscode" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li>Open debugging tab</li>
<li>Click on gear icon</li>
<li>Add next configuration</li>
</ol>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span>{
    &quot;name&quot;: &quot;Attach &quot;,
    &quot;type&quot;: &quot;python&quot;,
    &quot;request&quot;: &quot;attach&quot;,
    &quot;port&quot;: 8000, // Actual debugging port from bootup configuration
    &quot;host&quot;: &quot;localhost&quot;,
    &quot;pathMappings&quot;: [
        {
            &quot;localRoot&quot;: &quot;${workspaceFolder}&quot;,
            &quot;remoteRoot&quot;: &quot;/work-directory&quot;
        }
    ],
    &quot;redirectOutput&quot;: false
},
</pre></div>
</div>
<ol class="simple">
<li>Run <code class="docutils literal notranslate"><span class="pre">./legion-activate.sh</span></code> with <code class="docutils literal notranslate"><span class="pre">PTVSD_*</span></code> environment variables.</li>
<li>Run debugging configuration</li>
</ol>
</div>
</div>
<div class="section" id="example-of-usage">
<h2>Example of usage<a class="headerlink" href="#example-of-usage" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Go to project directory</span>
host&gt; <span class="nb">cd</span> /my-ml-project

<span class="c1"># Install legion CLI tools and python package</span>
host&gt; sudo pip3 install legion

<span class="c1"># Create sandbox</span>
host&gt; legionctl create-sandbox

<span class="c1"># Go inside sandbox</span>
host&gt; ./legion-activate.sh

<span class="c1"># Run Jupyter notebook server</span>
sandbox&gt; jupyter notebook

<span class="c1"># ... do actions inside Jupyter web console</span>
<span class="c1"># ... execute legion.model.save() inside Jupyter web console</span>

<span class="c1"># Create model&#39;s image</span>
sandbox&gt; legionctl build

<span class="c1"># Deploy model locally: legionctl deploy &lt;builded-model-image&gt; --local</span>
<span class="c1"># For example</span>
sandbox or host&gt; legionctl deploy model-summation:latest --local

<span class="c1"># Invoke model: legionctl invoke --model-id &lt;model-id&gt; --model-version &lt;model-version&gt; -p &lt;parameters&gt; --local</span>
<span class="c1"># For example</span>
sandbox or host&gt; legionctl invoke --model-id test-summation --model -version <span class="s1">&#39;2.0&#39;</span> -p <span class="nv">a</span><span class="o">=</span><span class="m">1</span> -p <span class="nv">b</span><span class="o">=</span><span class="m">2</span> --local

<span class="c1"># Undeploy your model: legionctl undeploy &lt;model-id&gt; --model-version &lt;model-version&gt; --local</span>
<span class="c1"># For example</span>
sandbox or host&gt; legionctl undeploy test-summation --model-version <span class="s1">&#39;2.0&#39;</span> --local
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Legion Team.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'1.2',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>